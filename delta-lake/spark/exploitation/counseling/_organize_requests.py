from pyspark.sql import SparkSession
from delta import *
from pyspark.sql.functions import col, to_timestamp, year, month, dayofmonth, hour, minute, second, broadcast
import duckdb

BASE_TRUSTED_PATH = '/data/trusted'
db_path = f'{BASE_TRUSTED_PATH}/databases/trusted_data.db'

builder = SparkSession.builder \
    .appName("CounselorsOrganizing") \
    .config("spark.driver.bindAddress", "0.0.0.0") \
    .config("spark.sql.extensions", "io.delta.sql.DeltaSparkSessionExtension") \
    .config("spark.sql.catalog.spark_catalog", "org.apache.spark.sql.delta.catalog.DeltaCatalog")

spark = configure_spark_with_delta_pip(builder).getOrCreate()

df = spark.read.format("mongodb") \
    .option("spark.mongodb.read.connection.uri", "mongodb://root:root@counseling-db:27017/?authSource=admin") \
    .option("database", "counseling") \
    .option("collection", "meeting-requests") \
    .load()

df.select("id", "student_id", "counselor_id", "timestamp").show()

df = df.select("id", "student_id", "counselor_id", "timestamp")
df = df.withColumn("timestamp", to_timestamp("timestamp", "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'"))
df = df.withColumn("year", year("timestamp")) \
       .withColumn("month", month("timestamp")) \
       .withColumn("day", dayofmonth("timestamp")) \
       .withColumn("hour", hour("timestamp"))

conn = duckdb.connect(db_path)
conn.execute("SHOW ALL TABLES").fetchone()
conn.execute("DESCRIBE trusted_student").fetchone()
student_ids = conn.execute("SELECT student_id FROM trusted_student").fetchall()
student_ids = [id[0] for id in student_ids]

df.filter(df.student_id == "eb318").show()

student_ids_df = spark.createDataFrame([(sid,) for sid in student_ids], ["student_id"])
filtered_df = df.join(broadcast(student_ids_df), on="student_id", how="inner")
filtered_df = filtered_df.select("id", "student_id", "counselor_id", "timestamp", "year", "month", "day", "hour")

# REPORTS

df = spark.read.format("mongodb") \
    .option("spark.mongodb.read.connection.uri", "mongodb://root:root@counseling-db:27017/?authSource=admin") \
    .option("database", "counseling") \
    .option("collection", "meeting-reports") \
    .load()